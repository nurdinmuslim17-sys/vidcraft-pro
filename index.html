<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>VidCraft Pro</title>

<style>
body{
  margin:0;
  background:#0b0f17;
  color:#eaeaf0;
  font-family:system-ui;
  display:flex;
  justify-content:center;
  padding:20px
}
.app{max-width:420px;width:100%}
.card{
  background:#141a26;
  padding:18px;
  border-radius:16px;
  margin-bottom:16px
}
h1{margin:0 0 8px}
input,button{
  width:100%;
  padding:14px;
  border-radius:12px;
  border:none;
  margin-top:10px;
  font-size:14px
}
input{background:#0b1020;color:white}
button{
  background:#6d5cff;
  color:white;
  font-weight:700;
  cursor:pointer
}
button:disabled{opacity:.6}
.status{font-size:13px;color:#9aa3b2;margin-top:8px}

.video-wrap{
  position:relative;
  margin-top:12px
}
video{
  width:100%;
  border-radius:12px
}
.hook{
  position:absolute;
  top:8%;
  left:50%;
  transform:translateX(-50%);
  background:rgba(0,0,0,.6);
  padding:10px 14px;
  border-radius:10px;
  font-weight:800;
  text-align:center;
  max-width:90%;
  display:none;
  font-size:18px
}
</style>
</head>

<body>
<div class="app">
<h1>üé¨ VidCraft Pro</h1>
<p class="status">Download ‚Üí Hook ‚Üí Re-export Original</p>

<div class="card">
  <b>‚¨áÔ∏è TikTok Downloader</b>
  <input id="url" placeholder="Tempel link TikTok">
  <button id="download">Download</button>
  <div id="dlStatus" class="status"></div>
</div>

<div class="card">
  <b>ü™ù Hook 3 Detik</b>
  <input id="hookText" placeholder="Contoh: Motor ini bikin kaget!">
</div>

<div class="card">
  <b>üéûÔ∏è Preview</b>
  <div class="video-wrap">
    <video id="video" controls></video>
    <div id="hook" class="hook"></div>
  </div>
  <button id="export" disabled>Export Video (Original)</button>
  <div id="exStatus" class="status">Idle</div>
</div>
</div>

<script>
const urlInput = document.getElementById("url");
const hookInput = document.getElementById("hookText");
const downloadBtn = document.getElementById("download");
const exportBtn = document.getElementById("export");
const video = document.getElementById("video");
const hook = document.getElementById("hook");
const dlStatus = document.getElementById("dlStatus");
const exStatus = document.getElementById("exStatus");

let sourceBlob;

downloadBtn.onclick = async () => {
  dlStatus.textContent = "Mengambil video...";
  try{
    const r = await fetch(`/api/tiktok?url=${encodeURIComponent(urlInput.value)}`);
    const j = await r.json();
    const v = await fetch(j.data.play);
    sourceBlob = await v.blob();
    video.src = URL.createObjectURL(sourceBlob);
    exportBtn.disabled = false;
    dlStatus.textContent = "Video siap";
  }catch{
    dlStatus.textContent = "Gagal download";
  }
};

video.ontimeupdate = () => {
  if(video.currentTime <= 3 && hookInput.value.trim()){
    hook.style.display = "block";
    hook.textContent = hookInput.value;
  }else{
    hook.style.display = "none";
  }
};

exportBtn.onclick = async () => {
  exStatus.textContent = "Re-export + subtitle...";
  exportBtn.disabled = true;

  const stream = document.querySelector(".video-wrap").captureStream();
  const recorder = new MediaRecorder(stream,{mimeType:"video/webm"});
  let chunks=[];

  recorder.ondataavailable=e=>chunks.push(e.data);
  recorder.onstop=()=>{
    const blob=new Blob(chunks,{type:"video/webm"});
    const a=document.createElement("a");
    a.href=URL.createObjectURL(blob);
    a.download=`vidcraft_${Date.now()}.webm`;
    a.click();
    exStatus.textContent="Export selesai";
    exportBtn.disabled=false;
  };

  video.currentTime=0;
  video.play();
  recorder.start();

  setTimeout(()=>{
    recorder.stop();
    video.pause();
  }, video.duration*1000);
};
</script>
</body>
</html>const result=document.getElementById("result")

btn.onclick=async()=>{
  if(!projectVideos.length){
    alert("Belum ada video dari TikTok"); return
  }

  btn.disabled=true
  bar.style.width="0%"
  result.innerHTML=""
  log.innerText="Loading FFmpeg..."

  if(!ffmpeg.isLoaded()) await ffmpeg.load()

  const hook=document.getElementById("hook").value.replace(/'/g,"")
  let step=100/projectVideos.length,prog=0

  for(let i=0;i<projectVideos.length;i++){
    log.innerText=`Processing ${i+1}/${projectVideos.length}`

    const input=`in${i}.mp4`
    const output=`vidcraft_${i}.mp4`

    ffmpeg.FS("writeFile",input,await fetchFile(projectVideos[i]))

    if(hook.trim()){
      await ffmpeg.run(
        "-i",input,
        "-vf",
        `drawtext=text='${hook}':fontcolor=white:fontsize=42:x=(w-text_w)/2:y=(h-text_h)/2:box=1:boxcolor=black@0.6:boxborderw=10:enable='lt(t,3)'`,
        "-c:a","copy",
        output
      )
    }else{
      await ffmpeg.run("-i",input,"-c","copy",output)
    }

    const data=ffmpeg.FS("readFile",output)
    const url=URL.createObjectURL(new Blob([data.buffer],{type:"video/mp4"}))

    const card=document.createElement("div")
    card.className="preview"
    card.innerHTML=`
      <video controls src="${url}"></video>
      <a href="${url}" download="${output}">‚¨áÔ∏è Download</a>
    `
    result.appendChild(card)

    prog+=step
    bar.style.width=prog+"%"
  }

  log.innerText="Selesai üéâ"
  btn.disabled=false
}
</script>
</body>
</html>
</div>

<script>
const { createFFmpeg, fetchFile } = FFmpeg
const ffmpeg = createFFmpeg({ log:false })

function setProgress(p){
  progressBox.style.display="block"
  progressBar.style.width=p+"%"
  progressText.innerText=p+"%"
}

function buildStory(product){
  const hooks=[
    "Banyak orang nyesel setelah beli ini.",
    "Produk ini lagi viral dan alasannya masuk akal.",
    "Masalah ini sering terjadi kalau salah pilih produk.",
    "Aku juga kaget pas lihat hasilnya."
  ]
  const hook=hooks[Math.floor(Math.random()*hooks.length)]
  const story=`Ini bukan ${product} biasa.
Pilihan tepat untuk kamu yang ingin kualitas dan kenyamanan terbaik.`
  return {hook,story}
}

function generateSRT(hook,story){
  return `1
00:00:00,000 --> 00:00:03,000
${hook}

2
00:00:03,000 --> 00:00:09,000
${story}`
}

async function generateTTS(text,gender){
  return new Promise(async(resolve)=>{
    const stream=await navigator.mediaDevices.getUserMedia({audio:true})
    const rec=new MediaRecorder(stream)
    let chunks=[]
    rec.ondataavailable=e=>chunks.push(e.data)
    rec.onstop=()=>resolve(new Blob(chunks,{type:'audio/webm'}))
    rec.start()

    let voices=speechSynthesis.getVoices()
    if(!voices.length) await new Promise(r=>speechSynthesis.onvoiceschanged=r)
    voices=speechSynthesis.getVoices()

    const utter=new SpeechSynthesisUtterance(text)
    utter.voice=voices.find(v=>v.lang==='id-ID')||voices[0]
    utter.lang='id-ID'
    utter.rate=0.9
    utter.pitch=gender==='male'?0.85:1.15

    utter.onend=()=>{
      setTimeout(()=>{
        rec.stop()
        stream.getTracks().forEach(t=>t.stop())
      },300)
    }
    speechSynthesis.speak(utter)
  })
}

async function generateBatch(){
  const files=[...videoInput.files]
  const productName=product.value
  if(!files.length||!productName) return alert("Lengkapi data")

  totalVideo.innerText=files.length

  if(!ffmpeg.isLoaded()){
    setProgress(5)
    await ffmpeg.load()
  }

  for(let i=0;i<files.length;i++){
    currentVideo.innerText=i+1
    setProgress(10)

    const {hook,story}=buildStory(productName)
    const fullText=hook+" "+story
    const tts=await generateTTS(fullText,voiceType.value)

    ffmpeg.FS('writeFile','input.mp4',await fetchFile(files[i]))
    ffmpeg.FS('writeFile','voice.webm',await fetchFile(tts))
    ffmpeg.FS('writeFile','subs.srt',
      new TextEncoder().encode(generateSRT(hook,story))
    )

    setProgress(60)

    const wmFilter=wmOn.checked
      ? `drawtext=text='${brand.value||"VidCraft Pro"}':
         fontcolor=white@0.18:fontsize=36:x=w-tw-20:y=20`
      : `null`

    await ffmpeg.run(
      '-i','input.mp4',
      '-i','voice.webm',
      '-filter_complex',
      `[0:v]scale=1080:1920,zoompan=z=1.05,${wmFilter},subtitles=subs.srt[v]`,
      '-map','[v]',
      '-map','1:a',
      '-shortest',
      'out.mp4'
    )

    setProgress(90)

    const data=ffmpeg.FS('readFile','out.mp4')
    const url=URL.createObjectURL(new Blob([data.buffer],{type:'video/mp4'}))
    const a=document.createElement("a")
    a.href=url
    a.download=`vidcraft_${i+1}.mp4`
    a.click()

    setProgress(100)
    await new Promise(r=>setTimeout(r,800))
  }
}
</script>

</body>
</html>

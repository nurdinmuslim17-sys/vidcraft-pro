<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>VidCraft Pro</title>
<meta name="viewport" content="width=device-width,initial-scale=1">

<script src="https://cdn.jsdelivr.net/npm/@ffmpeg/ffmpeg@0.12.6/dist/ffmpeg.min.js"></script>

<style>
body{margin:0;font-family:Inter,Arial;background:#0f1115;color:#fff}
.app{max-width:1000px;margin:auto;padding:20px}
h1{margin-bottom:4px}
.card{background:#161a22;border-radius:14px;padding:18px;margin-top:16px}
input,button{width:100%;padding:14px;border-radius:10px;border:none;margin-top:10px}
input{background:#0f1115;color:#fff;border:1px solid #2a2f3a}
button{background:linear-gradient(135deg,#6a5cff,#8b7bff);color:#fff;font-weight:600;cursor:pointer}
button:disabled{opacity:.6}
.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:14px;margin-top:14px}
.preview{background:#0f1115;border-radius:12px;padding:10px}
.preview video{width:100%;border-radius:10px}
.preview small{opacity:.7}
.preview a{display:block;text-align:center;margin-top:8px;
background:#22283a;padding:8px;border-radius:8px;color:#fff;text-decoration:none}
.progress{height:10px;background:#2a2f3a;border-radius:10px;overflow:hidden;margin-top:12px}
.bar{height:100%;width:0%;background:linear-gradient(90deg,#6a5cff,#8b7bff)}
.log{font-size:13px;opacity:.8;margin-top:8px}
hr{border:none;border-top:1px solid #2a2f3a;margin:22px 0}
</style>
</head>

<body>
<div class="app">
<h1>üé¨ VidCraft Pro</h1>
<p>Download TikTok ‚Üí langsung jadi video original</p>

<!-- TIKTOK -->
<div class="card">
<h3>‚¨áÔ∏è TikTok Downloader (HD No WM)</h3>
<input id="ttUrl" placeholder="Paste link TikTok">
<button onclick="downloadTikTok()">Download & Add to Project</button>
<div class="log" id="ttLog">Idle</div>
<div class="grid" id="ttPreview"></div>
</div>

<hr>

<!-- PROCESSOR -->
<div class="card">
<h3>üéûÔ∏è Video Processor</h3>
<input id="hook" placeholder="Hook 3 detik (opsional)">
<button id="generate">Generate Video</button>

<div class="progress"><div class="bar" id="bar"></div></div>
<div class="log" id="log">Idle</div>
</div>

<div class="grid" id="result"></div>
</div>

<script>
/* ================= TIKTOK PIPE ================= */
let projectVideos=[]

async function downloadTikTok(){
  const url=document.getElementById("ttUrl").value
  const log=document.getElementById("ttLog")
  const preview=document.getElementById("ttPreview")

  if(!url.includes("tiktok")){
    alert("Link TikTok tidak valid"); return
  }

  log.innerText="Fetching video..."
  preview.innerHTML=""

  try{
    const res=await fetch(`https://tikwm.com/api/?url=${encodeURIComponent(url)}`)
    const data=await res.json()
    if(!data.data){log.innerText="Gagal";return}

    const src=data.data.hdplay || data.data.play
    const blob=await fetch(src).then(r=>r.blob())
    projectVideos.push(blob)

    const card=document.createElement("div")
    card.className="preview"
    card.innerHTML=`
      <video controls src="${URL.createObjectURL(blob)}"></video>
      <small>Masuk ke project ‚úî</small>
    `
    preview.appendChild(card)

    log.innerText="Berhasil ditambahkan"
  }catch{
    log.innerText="Error download"
  }
}

/* ================= VIDCRAFT ================= */
const { createFFmpeg, fetchFile } = FFmpeg
const ffmpeg=createFFmpeg({
  log:true,
  corePath:"https://cdn.jsdelivr.net/npm/@ffmpeg/core@0.12.6/dist/ffmpeg-core.js"
})

const btn=document.getElementById("generate")
const bar=document.getElementById("bar")
const log=document.getElementById("log")
const result=document.getElementById("result")

btn.onclick=async()=>{
  if(!projectVideos.length){
    alert("Belum ada video dari TikTok"); return
  }

  btn.disabled=true
  bar.style.width="0%"
  result.innerHTML=""
  log.innerText="Loading FFmpeg..."

  if(!ffmpeg.isLoaded()) await ffmpeg.load()

  const hook=document.getElementById("hook").value.replace(/'/g,"")
  let step=100/projectVideos.length,prog=0

  for(let i=0;i<projectVideos.length;i++){
    log.innerText=`Processing ${i+1}/${projectVideos.length}`

    const input=`in${i}.mp4`
    const output=`vidcraft_${i}.mp4`

    ffmpeg.FS("writeFile",input,await fetchFile(projectVideos[i]))

    if(hook.trim()){
      await ffmpeg.run(
        "-i",input,
        "-vf",
        `drawtext=text='${hook}':fontcolor=white:fontsize=42:x=(w-text_w)/2:y=(h-text_h)/2:box=1:boxcolor=black@0.6:boxborderw=10:enable='lt(t,3)'`,
        "-c:a","copy",
        output
      )
    }else{
      await ffmpeg.run("-i",input,"-c","copy",output)
    }

    const data=ffmpeg.FS("readFile",output)
    const url=URL.createObjectURL(new Blob([data.buffer],{type:"video/mp4"}))

    const card=document.createElement("div")
    card.className="preview"
    card.innerHTML=`
      <video controls src="${url}"></video>
      <a href="${url}" download="${output}">‚¨áÔ∏è Download</a>
    `
    result.appendChild(card)

    prog+=step
    bar.style.width=prog+"%"
  }

  log.innerText="Selesai üéâ"
  btn.disabled=false
}
</script>
</body>
</html>
</div>

<script>
const { createFFmpeg, fetchFile } = FFmpeg
const ffmpeg = createFFmpeg({ log:false })

function setProgress(p){
  progressBox.style.display="block"
  progressBar.style.width=p+"%"
  progressText.innerText=p+"%"
}

function buildStory(product){
  const hooks=[
    "Banyak orang nyesel setelah beli ini.",
    "Produk ini lagi viral dan alasannya masuk akal.",
    "Masalah ini sering terjadi kalau salah pilih produk.",
    "Aku juga kaget pas lihat hasilnya."
  ]
  const hook=hooks[Math.floor(Math.random()*hooks.length)]
  const story=`Ini bukan ${product} biasa.
Pilihan tepat untuk kamu yang ingin kualitas dan kenyamanan terbaik.`
  return {hook,story}
}

function generateSRT(hook,story){
  return `1
00:00:00,000 --> 00:00:03,000
${hook}

2
00:00:03,000 --> 00:00:09,000
${story}`
}

async function generateTTS(text,gender){
  return new Promise(async(resolve)=>{
    const stream=await navigator.mediaDevices.getUserMedia({audio:true})
    const rec=new MediaRecorder(stream)
    let chunks=[]
    rec.ondataavailable=e=>chunks.push(e.data)
    rec.onstop=()=>resolve(new Blob(chunks,{type:'audio/webm'}))
    rec.start()

    let voices=speechSynthesis.getVoices()
    if(!voices.length) await new Promise(r=>speechSynthesis.onvoiceschanged=r)
    voices=speechSynthesis.getVoices()

    const utter=new SpeechSynthesisUtterance(text)
    utter.voice=voices.find(v=>v.lang==='id-ID')||voices[0]
    utter.lang='id-ID'
    utter.rate=0.9
    utter.pitch=gender==='male'?0.85:1.15

    utter.onend=()=>{
      setTimeout(()=>{
        rec.stop()
        stream.getTracks().forEach(t=>t.stop())
      },300)
    }
    speechSynthesis.speak(utter)
  })
}

async function generateBatch(){
  const files=[...videoInput.files]
  const productName=product.value
  if(!files.length||!productName) return alert("Lengkapi data")

  totalVideo.innerText=files.length

  if(!ffmpeg.isLoaded()){
    setProgress(5)
    await ffmpeg.load()
  }

  for(let i=0;i<files.length;i++){
    currentVideo.innerText=i+1
    setProgress(10)

    const {hook,story}=buildStory(productName)
    const fullText=hook+" "+story
    const tts=await generateTTS(fullText,voiceType.value)

    ffmpeg.FS('writeFile','input.mp4',await fetchFile(files[i]))
    ffmpeg.FS('writeFile','voice.webm',await fetchFile(tts))
    ffmpeg.FS('writeFile','subs.srt',
      new TextEncoder().encode(generateSRT(hook,story))
    )

    setProgress(60)

    const wmFilter=wmOn.checked
      ? `drawtext=text='${brand.value||"VidCraft Pro"}':
         fontcolor=white@0.18:fontsize=36:x=w-tw-20:y=20`
      : `null`

    await ffmpeg.run(
      '-i','input.mp4',
      '-i','voice.webm',
      '-filter_complex',
      `[0:v]scale=1080:1920,zoompan=z=1.05,${wmFilter},subtitles=subs.srt[v]`,
      '-map','[v]',
      '-map','1:a',
      '-shortest',
      'out.mp4'
    )

    setProgress(90)

    const data=ffmpeg.FS('readFile','out.mp4')
    const url=URL.createObjectURL(new Blob([data.buffer],{type:'video/mp4'}))
    const a=document.createElement("a")
    a.href=url
    a.download=`vidcraft_${i+1}.mp4`
    a.click()

    setProgress(100)
    await new Promise(r=>setTimeout(r,800))
  }
}
</script>

</body>
</html>

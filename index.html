<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>VidCraft Pro Universal</title>
<style>
body{margin:0;background:#0b0f17;color:#eaeaf0;font-family:system-ui;display:flex;justify-content:center;padding:20px}
.app{max-width:420px;width:100%}
.card{background:#141a26;padding:18px;border-radius:16px;margin-bottom:16px}
h1{margin:0 0 8px}
input,button,select{width:100%;padding:14px;border-radius:12px;border:none;margin-top:10px;font-size:14px}
input,select{background:#0b1020;color:white}
button{background:#6d5cff;color:white;font-weight:700;cursor:pointer}
button:disabled{opacity:.6}
.status{font-size:13px;color:#9aa3b2;margin-top:8px}
.video-wrap{position:relative;margin-top:12px}
video{width:100%;border-radius:12px}
.hook{position:absolute;top:8%;left:50%;transform:translateX(-50%);
background:rgba(0,0,0,.6);padding:10px 14px;border-radius:10px;font-weight:800;text-align:center;
max-width:90%;display:none;font-size:18px}
.progress{width:100%;height:10px;background:#1c2233;border-radius:5px;margin:10px 0}
.progress-bar{width:0%;height:100%;background:#6d5cff;border-radius:5px;transition:width 0.2s}
</style>
</head>
<body>
<div class="app">
<h1>üé¨ VidCraft Pro Universal</h1>
<p class="status">Download ‚Üí Pilih Hook ‚Üí Export Original</p>

<!-- TikTok Downloader -->
<div class="card">
<b>‚¨áÔ∏è TikTok Downloader</b>
<input id="url" placeholder="Tempel link TikTok">
<button id="download">Download</button>
<div id="dlStatus" class="status"></div>
</div>

<!-- Hook Template -->
<div class="card">
<b>ü™ù Pilih Hook 3 Detik</b>
<select id="hookSelect">
<option value="">-- Pilih Hook --</option>
<option value="Motor ini bikin kaget!">Motor ini bikin kaget!</option>
<option value="Gak nyangka endingnya!">Gak nyangka endingnya!</option>
<option value="Lihat trik rahasianya!">Lihat trik rahasianya!</option>
<option value="Kamu harus coba ini!">Kamu harus coba ini!</option>
<option value="Ini baru level pro!">Ini baru level pro!</option>
<option value="Rahasia ini bakal bikin kamu tercengang!">Rahasia ini bakal bikin kamu tercengang!</option>
<option value="Cuma 1 menit, tapi hasilnya WOW!">Cuma 1 menit, tapi hasilnya WOW!</option>
<option value="Trik ini jarang diketahui orang!">Trik ini jarang diketahui orang!</option>
<option value="Siapa sangka bisa semudah ini!">Siapa sangka bisa semudah ini!</option>
<option value="Kamu pasti nggak percaya endingnya!">Kamu pasti nggak percaya endingnya!</option>
<option value="Video ini bakal viral!">Video ini bakal viral!</option>
<option value="Lihat perubahan dramatisnya!">Lihat perubahan dramatisnya!</option>
<option value="Tips cepat yang wajib dicoba!">Tips cepat yang wajib dicoba!</option>
<option value="Ini cara orang pro melakukannya!">Ini cara orang pro melakukannya!</option>
<option value="Siap-siap terkejut dengan ini!">Siap-siap terkejut dengan ini!</option>
</select>
<input id="hookText" placeholder="Atau tulis sendiri">
</div>

<!-- Preview + Export -->
<div class="card">
<b>üéûÔ∏è Preview</b>
<div class="video-wrap">
<video id="video" controls></video>
<div id="hook" class="hook"></div>
</div>
<div class="progress">
<div class="progress-bar" id="progressBar"></div>
</div>
<button id="export" disabled>Export Video</button>
<div id="exStatus" class="status">Idle</div>
</div>
</div>

<script>
const urlInput=document.getElementById("url");
const downloadBtn=document.getElementById("download");
const hookSelect=document.getElementById("hookSelect");
const hookInput=document.getElementById("hookText");
const exportBtn=document.getElementById("export");
const video=document.getElementById("video");
const hook=document.getElementById("hook");
const dlStatus=document.getElementById("dlStatus");
const exStatus=document.getElementById("exStatus");
const progressBar=document.getElementById("progressBar");

let sourceBlob;

// Downloader TikTok
downloadBtn.onclick=async()=>{
const url=urlInput.value.trim();
if(!url) return;
dlStatus.textContent="Mengambil video...";
dlStatus.className="status";
try{
const res=await fetch(`/api/tiktok?url=${encodeURIComponent(url)}`);
const data=await res.json();
if(!data.data||!data.data.play) throw new Error("Video tidak ditemukan");
const vRes=await fetch(data.data.play);
sourceBlob=await vRes.blob();
video.src=URL.createObjectURL(sourceBlob);
video.onloadedmetadata=()=>{exportBtn.disabled=false;}
dlStatus.textContent="Video siap";
}catch(e){
dlStatus.textContent="Gagal download";
dlStatus.className="status error";
console.error(e);
}
};

// Dropdown sinkronisasi input
hookSelect.onchange=()=>{ if(hookSelect.value) hookInput.value=hookSelect.value; };

// overlay 3 detik
video.ontimeupdate=()=>{
if(video.currentTime<=3 && hookInput.value.trim()){
hook.style.display="block";
hook.textContent=hookInput.value;
}else hook.style.display="none";
};

// Export universal + status bar
exportBtn.onclick=async()=>{
if(!video.src){alert("Video belum ada");return;}
exStatus.textContent="Memproses export...";
exportBtn.disabled=true;
progressBar.style.width="0%";
try{
const isDesktop=('captureStream' in video);
if(isDesktop){
  await video.play();
  const stream=video.captureStream();
  const recorder=new MediaRecorder(stream,{mimeType:"video/webm"});
  let chunks=[];
  recorder.ondataavailable=e=>chunks.push(e.data);
  recorder.onstop=()=>{
    const blob=new Blob(chunks,{type:"video/webm"});
    const a=document.createElement("a");
    a.href=URL.createObjectURL(blob);
    a.download=`vidcraft_${Date.now()}.webm`;
    a.click();
    exStatus.textContent="Export selesai";
    exportBtn.disabled=false;
    progressBar.style.width="0%";
  };
  recorder.start();

  // Update progress bar
  const interval=setInterval(()=>{
    const perc=Math.min((video.currentTime/video.duration)*100,100);
    progressBar.style.width=perc+"%";
  },200);

  setTimeout(()=>{
    recorder.stop();
    video.pause();
    clearInterval(interval);
  }, video.duration*1000);

}else{
  // Mobile/Safari fallback
  exStatus.textContent="Upload untuk convert MP4...";
  const form=new FormData();
  form.append("video",sourceBlob,"video.webm");
  const res=await fetch("/api/convert",{method:"POST",body:form});
  const blob=await res.blob();
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download=`vidcraft_${Date.now()}.mp4`;
  a.click();
  exStatus.textContent="Export selesai (MP4 fallback)";
  exportBtn.disabled=false;
  progressBar.style.width="100%";
}
}catch(e){
  exStatus.textContent="Export gagal";
  exportBtn.disabled=false;
  progressBar.style.width="0%";
  console.error(e);
}
};
</script>
</body>
</html>
